<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Deposit Calculator - FinCalc</title>
    <meta name="description" content="Calculate deposit profitability with capitalization, regular contributions, withdrawals, progressive rates, and tax accounting.">
    
    <!-- Styles -->
    <link rel="stylesheet" href="../assets/styles-modern.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        .calculator-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 0;
        }
        
        .form-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
        }
        
        .form-section h3 {
            color: var(--primary);
            margin-bottom: var(--space-lg);
            font-size: 1.2rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }
        
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
            margin: var(--space-xl) 0;
        }
        
        .result-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            text-align: center;
        }
        
        .result-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: var(--space-sm);
        }
        
        .result-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .progressive-rate-section {
            background: var(--gray-50);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin: var(--space-md) 0;
        }
        
        .rate-breakdown {
            margin-top: var(--space-md);
        }
        
        .rate-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: var(--space-md);
            margin-bottom: var(--space-sm);
            align-items: center;
        }
        
        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .remove-btn:hover {
            background: #dc2626;
        }
        
        .add-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .add-btn:hover {
            background: #059669;
        }
        
        .regional-hint {
            background: var(--info-light);
            border-left: 3px solid var(--info);
            padding: var(--space-sm) var(--space-md);
            margin: var(--space-sm) 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-top: var(--space-xl);
            height: 400px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-xl);
            margin-top: var(--space-xl);
        }
        
        .breakdown-table {
            width: 100%;
            margin-top: var(--space-xl);
            border-collapse: collapse;
        }
        
        .breakdown-table th {
            background: var(--gray-100);
            padding: var(--space-md);
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }
        
        .breakdown-table td {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border);
        }
        
        .breakdown-table tr:hover {
            background: var(--gray-50);
        }
        
        .breakdown-table tfoot {
            background: var(--gray-100);
            font-weight: 600;
        }
        
        .breakdown-table .total-row td {
            border-top: 2px solid var(--border);
            padding-top: var(--space-lg);
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <a href="../index.html" class="logo">
                    <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" rx="8" fill="url(#gradient)"/>
                        <path d="M9 22L13 16L17 18L23 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="23" cy="10" r="2" fill="white"/>
                        <defs>
                            <linearGradient id="gradient" x1="0" y1="0" x2="32" y2="32">
                                <stop stop-color="#0066ff"/>
                                <stop offset="1" stop-color="#00a86b"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <span>FinCalc</span>
                </a>
                
                <nav class="nav-menu">
                    <a href="../index.html" class="nav-link" data-i18n="nav.home" onclick="i18n.navigateTo(event, '../index.html')">Home</a>
                    <a href="../index.html#calculators" class="nav-link active" data-i18n="nav.calculators" onclick="i18n.navigateTo(event, '../index.html#calculators')">Calculators</a>
                    <a href="../index.html#articles" class="nav-link" data-i18n="nav.articles" onclick="i18n.navigateTo(event, '../index.html#articles')">Articles</a>
                    <a href="../index.html#compare" class="nav-link" data-i18n="nav.compare" onclick="i18n.navigateTo(event, '../index.html#compare')">Compare</a>
                    
                    <div class="lang-dropdown">
                        <button class="lang-dropdown-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-globe"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                            <span class="lang-btn-text" data-i18n="nav.language">Language</span>
                        </button>
                        <div class="lang-dropdown-content">
                            <a href="#" onclick="i18n.setLanguage('en'); calculate(); return false;">English</a>
                            <a href="#" onclick="i18n.setLanguage('pl'); calculate(); return false;">Polski</a>
                            <a href="#" onclick="i18n.setLanguage('ru'); calculate(); return false;">Русский</a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </header>
    
    <!-- Calculator -->
    <div class="container calculator-container">
        <h1 data-i18n="deposit.title">Advanced Deposit Calculator</h1>
        <p class="mb-3" data-i18n="deposit.subtitle">Calculate deposit profitability with capitalization, contributions, withdrawals, and tax accounting</p>
        
        <!-- Basic Parameters -->
        <div class="form-section">
            <h3 data-i18n="deposit.basic_params">Basic Parameters</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" data-i18n="deposit.initial_amount">Initial Amount</label>
                    <input type="number" class="form-input" id="initialAmount" value="100000" min="0" step="1000">
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="deposit.currency">Currency</label>
                    <select class="form-select" id="currency">
                        <option value="USD" data-i18n="currency.usd">USD</option>
                        <option value="PLN" data-i18n="currency.pln">PLN</option>
                        <option value="RUB" data-i18n="currency.rub">RUB</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" data-i18n="deposit.start_date">Start Date</label>
                    <input type="date" class="form-input" id="startDate" value="">
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="deposit.term_days">Term (days)</label>
                    <input type="number" class="form-input" id="termDays" value="365" min="1" step="1">
                </div>
            </div>
            
            <div class="regional-hint" id="regionalHint"></div>
        </div>
        
        <!-- Interest Rate -->
        <div class="form-section">
            <h3 data-i18n="deposit.interest_rate">Interest Rate</h3>
            
            <div class="form-group">
                <label class="form-label" data-i18n="deposit.rate_type">Rate Type</label>
                <div style="display: flex; gap: var(--space-lg); margin-top: var(--space-sm);">
                    <label class="checkbox-row">
                        <input type="radio" name="rateType" value="fixed" checked>
                        <span data-i18n="deposit.fixed_rate">Fixed Rate</span>
                    </label>
                    <label class="checkbox-row">
                        <input type="radio" name="rateType" value="progressive">
                        <span data-i18n="deposit.progressive_rate">Progressive Rate</span>
                    </label>
                </div>
            </div>
            
            <div id="fixedRateSection">
                <div class="form-group">
                    <label class="form-label" data-i18n="deposit.annual_rate">Annual Rate (%)</label>
                    <input type="number" class="form-input" id="annualRate" value="10" min="0" max="100" step="0.1">
                </div>
            </div>
            
            <div id="progressiveRateSection" style="display: none;">
                <div class="progressive-rate-section">
                    <div class="rate-breakdown" id="rateBreakdown">
                        <!-- Динамически добавляемые строки ставок -->
                    </div>
                    <button type="button" class="add-btn" onclick="addProgressiveRate()" data-i18n="deposit.add_rate">Add Rate</button>
                </div>
            </div>
        </div>
        
        <!-- Capitalization and Payments -->
        <div class="form-section">
            <h3 data-i18n="deposit.capitalization">Capitalization & Payment Frequency</h3>
            
            <div class="checkbox-row">
                <input type="checkbox" id="capitalization" checked>
                <label data-i18n="deposit.enable_capitalization">Enable Interest Capitalization</label>
            </div>
            
            <div class="form-group">
                <label class="form-label" data-i18n="deposit.payment_frequency">Payment Frequency</label>
                <select class="form-select" id="paymentFrequency">
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="annually">Annually</option>
                    <option value="end" data-i18n="deposit.end_of_term">End of Term</option>
                </select>
            </div>
        </div>
        
        <!-- Contributions -->
        <div class="form-section">
            <h3 data-i18n="deposit.contributions">Regular Contributions</h3>
            
            <div class="checkbox-row">
                <input type="checkbox" id="enableContributions">
                <label data-i18n="deposit.enable_contributions">Enable Regular Contributions</label>
            </div>
            
            <div id="contributionsSection" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="deposit.contribution_amount">Amount</label>
                        <input type="number" class="form-input" id="contributionAmount" value="10000" min="0" step="1000">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="deposit.contribution_frequency">Frequency</label>
                        <select class="form-select" id="contributionFrequency">
                            <option value="monthly" data-i18n="frequency.monthly">Monthly</option>
                            <option value="quarterly" data-i18n="frequency.quarterly">Quarterly</option>
                            <option value="annually" data-i18n="frequency.annually">Annually</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Withdrawals -->
        <div class="form-section">
            <h3 data-i18n="deposit.withdrawals">Partial Withdrawals</h3>
            
            <div class="checkbox-row">
                <input type="checkbox" id="enableWithdrawals">
                <label data-i18n="deposit.enable_withdrawals">Enable Partial Withdrawals</label>
            </div>
            
            <div id="withdrawalsSection" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="deposit.withdrawal_amount">Amount</label>
                        <input type="number" class="form-input" id="withdrawalAmount" value="5000" min="0" step="1000">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="deposit.withdrawal_frequency">Frequency</label>
                        <select class="form-select" id="withdrawalFrequency">
                            <option value="monthly" data-i18n="frequency.monthly">Monthly</option>
                            <option value="quarterly" data-i18n="frequency.quarterly">Quarterly</option>
                            <option value="annually" data-i18n="frequency.annually">Annually</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tax -->
        <div class="form-section">
            <h3 data-i18n="deposit.tax">Tax</h3>
            
            <div class="form-group">
                <label class="form-label" data-i18n="deposit.tax_resident">Tax Status</label>
                <select class="form-select" id="taxStatus">
                    <option value="resident" data-i18n="deposit.tax_resident_yes">Tax Resident</option>
                    <option value="nonresident" data-i18n="deposit.tax_resident_no">Non-Resident</option>
                    <option value="none" data-i18n="deposit.tax_resident_none">No Tax</option>
                </select>
            </div>
            
            <div class="regional-hint" id="taxHint"></div>
        </div>
        
        <!-- Early Closure -->
        <div class="form-section">
            <h3 data-i18n="deposit.early_closure">Early Closure</h3>
            
            <div class="checkbox-row">
                <input type="checkbox" id="enableEarlyClosure">
                <label data-i18n="deposit.enable_early_closure">Calculate Early Closure</label>
            </div>
            
            <div id="earlyClosureSection" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="deposit.closure_date">Closure Date</label>
                        <input type="date" class="form-input" id="closureDate" value="">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="deposit.closure_rate">Early Closure Rate (%)</label>
                        <input type="number" class="form-input" id="closureRate" value="0.1" min="0" max="100" step="0.1">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results -->
        <div class="results-grid">
            <div class="result-item">
                <div class="result-label" data-i18n="deposit.final_balance">Final Balance</div>
                <div class="result-value" id="finalBalance">0</div>
            </div>
            <div class="result-item">
                <div class="result-label" data-i18n="deposit.total_interest">Total Interest</div>
                <div class="result-value" id="totalInterest">0</div>
            </div>
            <div class="result-item">
                <div class="result-label" data-i18n="deposit.total_tax">Total Tax</div>
                <div class="result-value" id="totalTax">0</div>
            </div>
            <div class="result-item">
                <div class="result-label" data-i18n="deposit.net_profit">Net Profit</div>
                <div class="result-value" id="netProfit">0</div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 data-i18n="deposit.balance_chart">Balance Growth</h3>
                <canvas id="balanceChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 data-i18n="deposit.comparison_chart">Comparison Chart</h3>
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
        
        <!-- Detailed Table -->
        <div style="margin-top: 2rem;">
            <h3 data-i18n="deposit.detailed_table">Detailed Monthly Breakdown</h3>
            <table class="breakdown-table">
                <thead>
                    <tr>
                        <th data-i18n="deposit.month">Month</th>
                        <th data-i18n="deposit.start_balance">Start Balance</th>
                        <th data-i18n="deposit.contributions">Contributions</th>
                        <th data-i18n="deposit.withdrawals">Withdrawals</th>
                        <th data-i18n="deposit.interest_accrued">Interest</th>
                        <th data-i18n="deposit.tax">Tax</th>
                        <th data-i18n="deposit.end_balance">End Balance</th>
                    </tr>
                </thead>
                <tbody id="depositTableBody"></tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="2"><strong data-i18n="deposit.total">TOTAL:</strong></td>
                        <td id="totalContributions">0</td>
                        <td id="totalWithdrawals">0</td>
                        <td id="totalInterestTable">0</td>
                        <td id="totalTaxTable">0</td>
                        <td id="finalBalanceTable">0</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 FinCalc. <span data-i18n="footer.disclaimer">Financial calculators for informational purposes only</span></p>
            </div>
        </div>
    </footer>
    
    <!-- Scripts -->
    <script src="../assets/i18n.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let balanceChart = null;
        let comparisonChart = null;
        let progressiveRateCounter = 0;
        
        // Regional defaults
        const regionalDefaults = {
            en: {
                currency: 'USD',
                taxRate: 0,
                typicalRates: { min: 4.5, max: 5.5, avg: 5.0 },
                rateHint: 'Typical US deposit rates: 4.5-5.5% APY',
                taxHint: 'Interest income is taxable. Consult with tax advisor.'
            },
            pl: {
                currency: 'PLN',
                taxRate: 0.19,
                typicalRates: { min: 5.5, max: 6.5, avg: 6.0 },
                rateHint: 'Typowe stawki depozytów w Polsce: 5.5-6.5%',
                taxHint: 'Podatek Belki 19% od odsetek kapitałowych'
            },
            ru: {
                currency: 'RUB',
                taxRate: 0.13,
                typicalRates: { min: 10.5, max: 12.5, avg: 11.5 },
                rateHint: 'Типичные ставки по вкладам в России: 10.5-12.5%',
                taxHint: 'Для резидентов РФ: НДФЛ 13% с процентов, превышающих ключевую ставку ЦБ × 1 млн ₽'
            }
        };
        
        // Initialize date inputs
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const startDate = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate;
            
            const closureDate = new Date(today);
            closureDate.setMonth(closureDate.getMonth() + 6);
            document.getElementById('closureDate').value = closureDate.toISOString().split('T')[0];
            
            // Set regional defaults
            updateRegionalDefaults();
            
            // Add event listeners
            document.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', calculate);
                el.addEventListener('input', calculate);
            });
            
            document.querySelectorAll('input[type="radio"]').forEach(el => {
                el.addEventListener('change', function() {
                    toggleRateType();
                    calculate();
                });
            });
            
            document.querySelectorAll('input[type="checkbox"]').forEach(el => {
                el.addEventListener('change', toggleSections);
            });
            
            // Set language
            const urlParams = new URLSearchParams(window.location.search);
            const langFromUrl = urlParams.get('lang');
            const savedLang = localStorage.getItem('preferredLanguage');
            const currentLang = langFromUrl || savedLang || 'en';
            
            i18n.setLanguage(currentLang);
            i18n.updatePage();
            calculate();
        });
        
        function updateRegionalDefaults() {
            const lang = i18n.currentLang;
            const defaults = regionalDefaults[lang];
            
            document.getElementById('currency').value = defaults.currency;
            document.getElementById('annualRate').value = defaults.typicalRates.avg;
            document.getElementById('regionalHint').textContent = defaults.rateHint;
            document.getElementById('taxHint').textContent = defaults.taxHint;
        }
        
        function toggleRateType() {
            const rateType = document.querySelector('input[name="rateType"]:checked').value;
            document.getElementById('fixedRateSection').style.display = rateType === 'fixed' ? 'block' : 'none';
            document.getElementById('progressiveRateSection').style.display = rateType === 'progressive' ? 'block' : 'none';
        }
        
        function toggleSections() {
            document.getElementById('contributionsSection').style.display = 
                document.getElementById('enableContributions').checked ? 'block' : 'none';
            document.getElementById('withdrawalsSection').style.display = 
                document.getElementById('enableWithdrawals').checked ? 'block' : 'none';
            document.getElementById('earlyClosureSection').style.display = 
                document.getElementById('enableEarlyClosure').checked ? 'block' : 'none';
        }
        
        function addProgressiveRate() {
            const rateBreakdown = document.getElementById('rateBreakdown');
            const rateRow = document.createElement('div');
            rateRow.className = 'rate-row';
            rateRow.id = 'rate-row-' + progressiveRateCounter;
            
            rateRow.innerHTML = `
                <input type="number" class="form-input" placeholder="Amount" min="0" step="1000" onchange="calculate()">
                <input type="number" class="form-input" placeholder="Rate %" min="0" max="100" step="0.1" onchange="calculate()">
                <button type="button" class="remove-btn" onclick="removeProgressiveRate('rate-row-${progressiveRateCounter}')">Remove</button>
            `;
            
            rateBreakdown.appendChild(rateRow);
            progressiveRateCounter++;
        }
        
        function removeProgressiveRate(id) {
            document.getElementById(id).remove();
            calculate();
        }
        
        function calculate() {
            const initialAmount = parseFloat(document.getElementById('initialAmount').value) || 0;
            const currency = document.getElementById('currency').value;
            const startDate = new Date(document.getElementById('startDate').value);
            const termDays = parseInt(document.getElementById('termDays').value) || 0;
            const capitalization = document.getElementById('capitalization').checked;
            const paymentFrequency = document.getElementById('paymentFrequency').value;
            const enableContributions = document.getElementById('enableContributions').checked;
            const contributionAmount = parseFloat(document.getElementById('contributionAmount').value) || 0;
            const contributionFrequency = document.getElementById('contributionFrequency').value;
            const enableWithdrawals = document.getElementById('enableWithdrawals').checked;
            const withdrawalAmount = parseFloat(document.getElementById('withdrawalAmount').value) || 0;
            const withdrawalFrequency = document.getElementById('withdrawalFrequency').value;
            const taxStatus = document.getElementById('taxStatus').value;
            const enableEarlyClosure = document.getElementById('enableEarlyClosure').checked;
            const closureDate = new Date(document.getElementById('closureDate').value);
            const closureRate = parseFloat(document.getElementById('closureRate').value) || 0;
            
            // Get interest rate
            let annualRate = 0;
            const rateType = document.querySelector('input[name="rateType"]:checked').value;
            
            if (rateType === 'fixed') {
                annualRate = parseFloat(document.getElementById('annualRate').value) || 0;
            } else {
                // Use first progressive rate for now
                const firstRate = document.querySelector('.rate-row input[placeholder="Rate %"]');
                annualRate = parseFloat(firstRate?.value) || 0;
            }
            
            // Set currency for formatting
            i18n.formatCurrency = function(num) {
                return new Intl.NumberFormat(i18n.getLocale(), {
                    style: 'currency',
                    currency: currency,
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(num);
            };
            
            // Get tax rate
            let taxRate = 0;
            if (taxStatus === 'resident') {
                taxRate = regionalDefaults[i18n.currentLang].taxRate;
            }
            
            // Calculate
            const monthlyData = [];
            let balance = initialAmount;
            let totalContributions = 0;
            let totalWithdrawals = 0;
            let totalInterest = 0;
            let totalTax = 0;
            
            const actualDays = enableEarlyClosure ? 
                Math.floor((closureDate - startDate) / (1000 * 60 * 60 * 24)) : termDays;
            
            const monthlyRate = annualRate / 100 / 12;
            const months = Math.ceil(actualDays / 30);
            
            for (let month = 0; month < months; month++) {
                const monthStart = balance;
                let monthInterest = 0;
                let monthContributions = 0;
                let monthWithdrawals = 0;
                
                // Contributions
                if (enableContributions && shouldContribute(month, contributionFrequency)) {
                    monthContributions = contributionAmount;
                    balance += contributionAmount;
                    totalContributions += contributionAmount;
                }
                
                // Interest
                if (capitalization || paymentFrequency === 'monthly') {
                    monthInterest = balance * monthlyRate;
                    balance += monthInterest;
                    totalInterest += monthInterest;
                }
                
                // Withdrawals
                if (enableWithdrawals && shouldWithdraw(month, withdrawalFrequency)) {
                    monthWithdrawals = Math.min(withdrawalAmount, balance);
                    balance -= monthWithdrawals;
                    totalWithdrawals += monthWithdrawals;
                }
                
                // Tax
                const monthTax = monthInterest * taxRate;
                balance -= monthTax;
                totalTax += monthTax;
                
                // Apply early closure rate at the end
                if (enableEarlyClosure && month === months - 1) {
                    const earlyDays = actualDays % 30;
                    const earlyRate = closureRate / 100 / 365 * earlyDays;
                    const earlyInterest = balance * earlyRate;
                    balance += earlyInterest;
                    monthInterest += earlyInterest;
                    totalInterest += earlyInterest;
                }
                
                monthlyData.push({
                    month: month + 1,
                    startBalance: monthStart,
                    contributions: monthContributions,
                    withdrawals: monthWithdrawals,
                    interest: monthInterest,
                    tax: monthTax,
                    endBalance: balance
                });
            }
            
            // Update results
            document.getElementById('finalBalance').textContent = i18n.formatCurrency(balance);
            document.getElementById('totalInterest').textContent = i18n.formatCurrency(totalInterest);
            document.getElementById('totalTax').textContent = i18n.formatCurrency(totalTax);
            document.getElementById('netProfit').textContent = i18n.formatCurrency(balance - initialAmount - totalContributions + totalWithdrawals);
            
            // Update table
            updateTable(monthlyData);
            
            // Update charts
            updateCharts(monthlyData, initialAmount);
        }
        
        function shouldContribute(month, frequency) {
            const frequencies = { monthly: 1, quarterly: 3, annually: 12 };
            return month % frequencies[frequency] === 0;
        }
        
        function shouldWithdraw(month, frequency) {
            return shouldContribute(month, frequency);
        }
        
        function updateTable(data) {
            const tbody = document.getElementById('depositTableBody');
            tbody.innerHTML = '';
            
            let totalContrib = 0;
            let totalWithd = 0;
            let totalInt = 0;
            let totalTaxAmount = 0;
            
            data.forEach(row => {
                totalContrib += row.contributions;
                totalWithd += row.withdrawals;
                totalInt += row.interest;
                totalTaxAmount += row.tax;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${row.month}</strong></td>
                    <td>${i18n.formatCurrency(row.startBalance)}</td>
                    <td>${i18n.formatCurrency(row.contributions)}</td>
                    <td>${i18n.formatCurrency(row.withdrawals)}</td>
                    <td style="color: var(--success);">${i18n.formatCurrency(row.interest)}</td>
                    <td style="color: var(--danger);">${i18n.formatCurrency(row.tax)}</td>
                    <td><strong>${i18n.formatCurrency(row.endBalance)}</strong></td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('totalContributions').textContent = i18n.formatCurrency(totalContrib);
            document.getElementById('totalWithdrawals').textContent = i18n.formatCurrency(totalWithd);
            document.getElementById('totalInterestTable').textContent = i18n.formatCurrency(totalInt);
            document.getElementById('totalTaxTable').textContent = i18n.formatCurrency(totalTaxAmount);
            document.getElementById('finalBalanceTable').textContent = i18n.formatCurrency(data[data.length - 1].endBalance);
        }
        
        function updateCharts(data, initialAmount) {
            const labels = data.map((_, i) => i18n.t('chart.month') + ' ' + (i + 1));
            const balanceData = data.map(d => d.endBalance);
            const principalData = data.map((_, i) => initialAmount + data.slice(0, i + 1).reduce((sum, d) => sum + d.contributions - d.withdrawals, 0));
            const interestData = data.map((_, i) => data.slice(0, i + 1).reduce((sum, d) => sum + d.interest, 0));
            
            // Balance Chart
            const balanceCtx = document.getElementById('balanceChart').getContext('2d');
            if (balanceChart) balanceChart.destroy();
            
            balanceChart = new Chart(balanceCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: i18n.t('deposit.balance'),
                        data: balanceData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return i18n.formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: (value) => i18n.formatCurrency(value)
                            }
                        }
                    }
                }
            });
            
            // Comparison Chart
            const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
            if (comparisonChart) comparisonChart.destroy();
            
            comparisonChart = new Chart(comparisonCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: i18n.t('deposit.principal'),
                            data: principalData,
                            backgroundColor: '#3b82f6',
                            stack: 'stack0'
                        },
                        {
                            label: i18n.t('deposit.interest'),
                            data: interestData,
                            backgroundColor: '#10b981',
                            stack: 'stack0'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + i18n.formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true },
                        y: {
                            stacked: true,
                            ticks: {
                                callback: (value) => i18n.formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>

